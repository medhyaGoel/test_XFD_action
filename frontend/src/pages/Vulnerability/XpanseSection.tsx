import React from 'react';
import {
  Grid,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableRow,
  Typography
} from '@mui/material';
import { tableCellClasses } from '@mui/material/TableCell';
import Markdown from 'react-markdown';
import { Vulnerability as VulnerabilityType } from 'types';
import { humanReadableDate } from 'utils/dateUtils';

interface XpanseSectionProps {
  vulnerability: VulnerabilityType;
}

export const XpanseSection: React.FC<XpanseSectionProps> = ({
  vulnerability
}) => {
  return (
    <Grid container sx={{ backgroundColor: 'white' }}>
      <Grid item xs={12} sm={6} p={2}>
        <Typography variant="h6" gutterBottom mt={1}>
          Alert Policy Description
        </Typography>
        <Markdown>{vulnerability.description}</Markdown>
        <Typography variant="h6" gutterBottom mt={2}>
          Alert Evidence
        </Typography>
        <TableContainer>
          <Table size="small">
            <TableBody>
              <TableRow>
                <TableCell component="th" scope="row">
                  First Observed in Xpanse
                </TableCell>
                <TableCell scope="row">
                  {humanReadableDate(
                    vulnerability.structuredData?.xpanse_insert_ts
                  ) || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  Last Observed in Xpanse
                </TableCell>
                <TableCell scope="row">
                  {humanReadableDate(
                    vulnerability.structuredData?.xpanse_last_observed
                  ) || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  IPv4 Address
                </TableCell>
                <TableCell scope="row">
                  {vulnerability.structuredData?.ipv4_addresses || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  Port Number
                </TableCell>
                <TableCell scope="row">
                  {vulnerability.structuredData?.action_remote_port || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  Port Protocol
                </TableCell>
                <TableCell scope="row">
                  {vulnerability.structuredData?.port_protocol || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  HTTP Path
                </TableCell>
                <TableCell scope="row">
                  {vulnerability.structuredData?.asset_identifiers[0]
                    .httpPath || 'N/A'}
                </TableCell>
              </TableRow>
              <TableRow>
                <TableCell component="th" scope="row">
                  Resolution Status
                </TableCell>
                <TableCell scope="row">
                  {vulnerability.structuredData?.resolution_status || 'N/A'}
                </TableCell>
              </TableRow>
              {!vulnerability.structuredData?.certificate && (
                <TableRow>
                  <TableCell component="th" scope="row">
                    Certificate
                  </TableCell>
                  <TableCell scope="row">N/A</TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>
        {vulnerability.structuredData?.certificate && (
          <>
            <Typography variant="body2" mt={1} ml={2}>
              Certificate
            </Typography>
            <TableContainer>
              <Table
                size="small"
                sx={{
                  [`& .${tableCellClasses.root}`]: { borderBottom: 'none' }
                }}
              >
                <TableBody>
                  <TableRow>
                    <TableCell
                      component="th"
                      scope="row"
                      align="right"
                      sx={{ width: 150 }}
                    >
                      Subject Name
                    </TableCell>
                    <TableCell scope="row" align="left">
                      {vulnerability.structuredData?.certificate?.subjectName ||
                        'N/A'}
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell component="th" scope="row" align="right">
                      Issuer Name
                    </TableCell>
                    <TableCell component="th" scope="row">
                      {vulnerability.structuredData?.certificate?.issuerName ||
                        'N/A'}
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell component="th" scope="row" align="right">
                      Serial Number
                    </TableCell>
                    <TableCell scope="row">
                      {vulnerability.structuredData?.certificate
                        ?.serialNumber || 'N/A'}
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell component="th" scope="row" align="right">
                      Valid Not Before
                    </TableCell>
                    <TableCell scope="row">
                      {vulnerability.structuredData?.certificate
                        ?.validNotBefore || 'N/A'}
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell component="th" scope="row" align="right">
                      Valid Not After
                    </TableCell>
                    <TableCell scope="row">
                      {vulnerability.structuredData?.certificate
                        ?.validNotAfter || 'N/A'}
                    </TableCell>
                  </TableRow>
                </TableBody>
              </Table>
            </TableContainer>
          </>
        )}
      </Grid>
      <Grid item xs={12} sm={6} p={2}>
        <Typography variant="h6" gutterBottom mt={1}>
          How to Remediate
        </Typography>
        <Markdown>
          {vulnerability.structuredData?.remediation_guidance}
        </Markdown>
      </Grid>
    </Grid>
  );
};
